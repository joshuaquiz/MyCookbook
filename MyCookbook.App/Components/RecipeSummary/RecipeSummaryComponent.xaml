<?xml version="1.0" encoding="utf-8" ?>
<ContentView
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:recipeSummary="clr-namespace:MyCookbook.App.Components.RecipeSummary"
    xmlns:converters="clr-namespace:MyCookbook.App.Converters"
    x:Class="MyCookbook.App.Components.RecipeSummary.RecipeSummaryComponent"
    x:Name="Root"
    HorizontalOptions="Fill"
    VerticalOptions="End"
    Padding="0,0,0,8"
    BindingContext="{recipeSummary:RecipeSummaryViewModel}">
    <ContentView.Resources>
        <converters:NullToBooleanConverter x:Key="NullToBooleanConverter" />
        <converters:DefaultValueConverter x:Key="DefaultValueConverter" />
        <converters:TimeWithPrepConverter x:Key="TimeWithPrepConverter" />
    </ContentView.Resources>
    <Border
        StrokeThickness="0"
        HorizontalOptions="Fill"
        VerticalOptions="Fill"
        Padding="0"
        Margin="0">
        <Border.StrokeShape>
            <RoundRectangle CornerRadius="5" />
        </Border.StrokeShape>
        <Border.GestureRecognizers>
            <TapGestureRecognizer
                Tapped="OnTapped" />
        </Border.GestureRecognizers>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="CommonStates">
                <VisualState x:Name="Normal">
                    <VisualState.Setters>
                        <Setter Property="Opacity" Value="1" />
                        <Setter Property="Scale" Value="1" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="Pressed">
                    <VisualState.Setters>
                        <Setter Property="Opacity" Value="0.7" />
                        <Setter Property="Scale" Value="0.98" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        <Grid
            HorizontalOptions="Fill"
            VerticalOptions="Fill"
            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="10" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="10" />
                <RowDefinition Height="1" />
                <RowDefinition Height="235" />
                <RowDefinition Height="1" />
                <RowDefinition Height="10" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="10" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="10" />
            </Grid.ColumnDefinitions>

            <!-- Recipe Name Header -->
            <Label
                Grid.Row="0"
                Grid.Column="1"
                Text="{Binding Name}"
                VerticalOptions="Center"
                HorizontalOptions="Start"
                LineBreakMode="TailTruncation"
                FontSize="28"
                FontAttributes="Bold"
                Margin="0,5,0,0" />

            <!-- Author Section -->
            <Grid
                Grid.Row="2"
                Grid.Column="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Border
                    Grid.Column="0"
                    StrokeThickness="0"
                    HeightRequest="50"
                    WidthRequest="50"
                    VerticalOptions="Center"
                    Margin="0,0,10,0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="25" />
                    </Border.StrokeShape>
                    <Border.Triggers>
                        <DataTrigger
                            TargetType="Border"
                            Binding="{Binding AuthorImageUrl, Converter={StaticResource NullToBooleanConverter}}"
                            Value="True">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </Border.Triggers>
                    <Image
                        Source="{Binding AuthorImageUrl}"
                        Aspect="AspectFill"
                        HeightRequest="50"
                        WidthRequest="50"
                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}" />
                </Border>
                <VerticalStackLayout
                    Grid.Column="1"
                    VerticalOptions="Center"
                    Spacing="2">
                    <Label
                        Text="{Binding AuthorName}"
                        FontSize="18"
                        FontAttributes="Bold"
                        LineBreakMode="TailTruncation" />
                    <Label
                        Text="{Binding ItemUrl.Host}"
                        FontSize="14"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                        LineBreakMode="TailTruncation">
                        <Label.Triggers>
                            <DataTrigger
                                TargetType="Label"
                                Binding="{Binding ItemUrl, Converter={StaticResource NullToBooleanConverter}}"
                                Value="True">
                                <Setter Property="IsVisible" Value="False" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                </VerticalStackLayout>
                <Label
                    Grid.Column="2"
                    Text="{Binding Difficulty}"
                    VerticalOptions="Center"
                    HorizontalOptions="End"
                    FontSize="16"
                    TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                    Margin="10,0,0,0" />
            </Grid>

            <!-- Border above image -->
            <BoxView
                Grid.Row="4"
                Grid.Column="0"
                Grid.ColumnSpan="3"
                HeightRequest="1"
                Color="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />

            <!-- Recipe Image Carousel -->
            <Grid
                x:Name="ImageCarouselContainer"
                Grid.Row="5"
                Grid.Column="0"
                Grid.ColumnSpan="3"
                HorizontalOptions="Fill"
                VerticalOptions="Fill">
                <Grid.Triggers>
                    <DataTrigger
                        TargetType="Grid"
                        Binding="{Binding ImageUrls, Converter={StaticResource NullToBooleanConverter}}"
                        Value="True">
                        <Setter Property="IsVisible" Value="False" />
                    </DataTrigger>
                </Grid.Triggers>

                <CarouselView
                    x:Name="ImageCarousel"
                    ItemsSource="{Binding ImageUrls}"
                    IndicatorView="ImageIndicator"
                    Position="0"
                    HorizontalOptions="Fill"
                    VerticalOptions="Fill"
                    Loop="False"
                    HorizontalScrollBarVisibility="Never">
                    <CarouselView.ItemTemplate>
                        <DataTemplate>
                            <Image
                                Source="{Binding .}"
                                Aspect="AspectFill"
                                HorizontalOptions="Fill"
                                VerticalOptions="Fill">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Tapped="OnImageTapped" />
                                </Image.GestureRecognizers>
                            </Image>
                        </DataTemplate>
                    </CarouselView.ItemTemplate>
                </CarouselView>

                <!-- Dot Indicators -->
                <IndicatorView
                    x:Name="ImageIndicator"
                    VerticalOptions="End"
                    HorizontalOptions="Center"
                    Margin="0,0,0,10"
                    IndicatorColor="{StaticResource Gray400}"
                    SelectedIndicatorColor="{StaticResource Tertiary}"
                    IndicatorSize="8">
                    <IndicatorView.Triggers>
                        <DataTrigger
                            TargetType="IndicatorView"
                            Binding="{Binding ImageUrls.Count}"
                            Value="1">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                        <DataTrigger
                            TargetType="IndicatorView"
                            Binding="{Binding ImageUrls.Count}"
                            Value="0">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </IndicatorView.Triggers>
                </IndicatorView>
            </Grid>

            <!-- Border below image -->
            <BoxView
                Grid.Row="6"
                Grid.Column="0"
                Grid.ColumnSpan="3"
                HeightRequest="1"
                Color="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />

            <!-- Summary Info Section -->
            <VerticalStackLayout
                Grid.Row="8"
                Grid.Column="1"
                Spacing="8"
                Margin="0,0,0,10">

                <!-- Row 1: Duration (left) and Category (right) -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <HorizontalStackLayout
                        Grid.Column="0"
                        Spacing="5"
                        HorizontalOptions="Start">
                        <Image
                            Source="timer"
                            HeightRequest="18"
                            WidthRequest="18"
                            VerticalOptions="Center"
                            Aspect="AspectFit" />
                        <Label
                            VerticalOptions="Center"
                            FontSize="16">
                            <Label.Text>
                                <MultiBinding Converter="{StaticResource TimeWithPrepConverter}">
                                    <Binding Path="TotalTime" />
                                    <Binding Path="PrepTime" />
                                </MultiBinding>
                            </Label.Text>
                        </Label>
                    </HorizontalStackLayout>
                    <Label
                        Grid.Column="1"
                        Text="{Binding Category}"
                        VerticalOptions="Center"
                        HorizontalOptions="End"
                        FontSize="16"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                        LineBreakMode="TailTruncation" />
                </Grid>

                <!-- Row 2: Servings (left) and Calories (right) -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Label
                        Grid.Column="0"
                        VerticalOptions="Center"
                        HorizontalOptions="Start"
                        FontSize="16">
                        <Label.Text>
                            <MultiBinding StringFormat="{}{0} Servings">
                                <Binding Path="Servings"></Binding>
                            </MultiBinding>
                        </Label.Text>
                        <Label.Triggers>
                            <DataTrigger
                                TargetType="Label"
                                Binding="{Binding Servings, Converter={StaticResource DefaultValueConverter}}"
                                Value="True">
                                <Setter Property="IsVisible" Value="False" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Label
                        Grid.Column="1"
                        VerticalOptions="Center"
                        HorizontalOptions="End"
                        FontSize="16"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}">
                        <Label.Text>
                            <MultiBinding StringFormat="{}~{0} cal">
                                <Binding Path="Calories"></Binding>
                            </MultiBinding>
                        </Label.Text>
                        <Label.Triggers>
                            <DataTrigger
                                TargetType="Label"
                                Binding="{Binding Calories, Converter={StaticResource DefaultValueConverter}}"
                                Value="True">
                                <Setter Property="IsVisible" Value="False" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                </Grid>

                <!-- Row 3: Hearts, Rating (left) and Tags (right) -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="10" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Label
                        Grid.Column="0"
                        VerticalOptions="Center"
                        HorizontalOptions="Start"
                        FontSize="16"
                        Margin="0,0,10,0">
                        <Label.Text>
                            <MultiBinding StringFormat="{}❤️ {0}">
                                <Binding Path="Hearts"></Binding>
                            </MultiBinding>
                        </Label.Text>
                    </Label>
                    <Label
                        Grid.Column="1"
                        VerticalOptions="Center"
                        HorizontalOptions="Start"
                        FontSize="16"
                        Margin="0,0,0,0">
                        <Label.Text>
                            <MultiBinding StringFormat="{}⭐ {0:F1}">
                                <Binding Path="Rating"></Binding>
                            </MultiBinding>
                        </Label.Text>
                    </Label>
                    <Label
                        Grid.Column="3"
                        Text="{Binding Tags}"
                        VerticalOptions="Center"
                        HorizontalOptions="Start"
                        FontSize="14"
                        TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                        LineBreakMode="TailTruncation" />
                </Grid>
            </VerticalStackLayout>
        </Grid>
    </Border>
</ContentView>