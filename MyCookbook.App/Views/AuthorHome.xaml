<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="MyCookbook.App.Views.AuthorHome"
    xmlns:views="using:MyCookbook.App.Views"
    xmlns:viewModels="using:MyCookbook.App.ViewModels"
    xmlns:recipeSummaryList="clr-namespace:MyCookbook.App.Components.RecipeSummaryList"
    xmlns:converters="clr-namespace:MyCookbook.App.Converters"
    xmlns:controls="clr-namespace:MyCookbook.App.Controls"
    xmlns:adControls="clr-namespace:Plugin.MauiMTAdmob.Controls;assembly=Plugin.MauiMTAdmob"
    xmlns:constants="clr-namespace:MyCookbook.App.Constants"
    x:DataType="viewModels:AuthorProfilePageViewModel"
    x:Name="Root"
    Title="{Binding AuthorViewModel.Name}"
    Shell.NavBarIsVisible="True"
    Shell.PresentationMode="Animated">
    <ContentPage.Resources>
        <converters:EqualToConverter x:Key="EqualToConverter" />
        <converters:StringToUriConverter x:Key="StringToUriConverter" />
    </ContentPage.Resources>
    <ContentPage.ToolbarItems>
        <ToolbarItem
            Text="Settings"
            IconImageSource="gear"
            Command="{Binding SettingsCommand}" />
    </ContentPage.ToolbarItems>
    <Grid RowDefinitions="Auto,*,{StaticResource HeightMedium}">
        <!-- Header Section with Images and Info -->
        <VerticalStackLayout Grid.Row="0">
            <!-- Background Image with Circular Profile Image Overlay -->
            <Grid HeightRequest="{StaticResource HeightHero}">
                <controls:CachedImage
                    Source="{Binding AuthorViewModel.BackgroundImageUri, Converter={StaticResource StringToUriConverter}}"
                    Aspect="AspectFill"
                    HorizontalOptions="Fill"
                    VerticalOptions="Fill" />
                <Border
                    Margin="{StaticResource MarginTopXXLarge}"
                    HeightRequest="{StaticResource HeightXXLarge}"
                    WidthRequest="{StaticResource HeightXXLarge}"
                    Stroke="{StaticResource White}"
                    StrokeThickness="4"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    Padding="{StaticResource ThicknessNone}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="{StaticResource CornerRadiusCircle}" />
                    </Border.StrokeShape>
                    <controls:CachedImage
                        Source="{Binding AuthorViewModel.ProfileImageUri, Converter={StaticResource StringToUriConverter}}"
                        Aspect="AspectFill" />
                </Border>
            </Grid>

            <!-- Author Name -->
            <Label
                Text="{Binding AuthorViewModel.Name}"
                FontAttributes="Bold"
                TextColor="{AppThemeBinding Light={StaticResource ProfileAccent}, Dark={StaticResource White}}"
                HorizontalTextAlignment="Center"
                Margin="{StaticResource MarginTopMedium}"
                FontSize="{StaticResource FontSizeHeadingLarge}" />

            <!-- Location -->
            <HorizontalStackLayout
                HorizontalOptions="Center"
                Margin="{StaticResource MarginTopSmall}"
                Spacing="{StaticResource SpacingSmall}">
                <Image
                    Source="location"
                    WidthRequest="{StaticResource IconSizeSmall}"
                    HeightRequest="{StaticResource IconSizeSmall}"
                    VerticalOptions="Center" />
                <Label
                    Text="{Binding AuthorViewModel.Location}"
                    FontSize="{StaticResource FontSizeBodyMedium}"
                    VerticalOptions="Center" />
            </HorizontalStackLayout>

            <!-- Bio Section with Spinner -->
            <Grid
                Margin="{StaticResource MarginTopMedium}"
                Padding="{StaticResource PaddingStandard}"
                MinimumHeightRequest="100">
                <Label
                    Text="{Binding AuthorViewModel.Bio}"
                    HorizontalTextAlignment="Start"
                    FontSize="{StaticResource FontSizeBodyLarge}"
                    IsVisible="{Binding IsNotBusy}" />
                <ActivityIndicator
                    IsRunning="{Binding IsBusy}"
                    IsVisible="{Binding IsBusy}"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}" />
            </Grid>
        </VerticalStackLayout>

        <!-- Tabbed Content Section -->
        <Grid Grid.Row="1" RowDefinitions="Auto,*">
            <!-- Tab Headers -->
            <Grid Grid.Row="0" ColumnDefinitions="*,*" Margin="{StaticResource MarginTopMedium}">
                <!-- Recipes Tab -->
                <Border
                    Grid.Column="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                    Padding="{StaticResource PaddingMedium}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding Source={x:Reference Root}, Path=BindingContext.SelectRecipesTabCommand}" />
                    </Border.GestureRecognizers>
                    <Label
                        Text="{Binding RecipesTabTitle}"
                        FontAttributes="Bold"
                        FontSize="{StaticResource FontSizeTitleMedium}"
                        HorizontalTextAlignment="Center"
                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}">
                        <Label.Triggers>
                            <DataTrigger TargetType="Label" Binding="{Binding SelectedTabIndex}" Value="0">
                                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Border.Triggers>
                        <DataTrigger TargetType="Border" Binding="{Binding SelectedTabIndex}" Value="0">
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                        </DataTrigger>
                    </Border.Triggers>
                </Border>

                <!-- Cookbook Tab (only visible for current user) -->
                <Border
                    Grid.Column="1"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                    Padding="{StaticResource PaddingMedium}"
                    IsVisible="{Binding IsCurrentUser}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding Source={x:Reference Root}, Path=BindingContext.SelectCookbookTabCommand}" />
                    </Border.GestureRecognizers>
                    <Label
                        Text="Cookbook"
                        FontAttributes="Bold"
                        FontSize="{StaticResource FontSizeTitleMedium}"
                        HorizontalTextAlignment="Center"
                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}">
                        <Label.Triggers>
                            <DataTrigger TargetType="Label" Binding="{Binding SelectedTabIndex}" Value="1">
                                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Border.Triggers>
                        <DataTrigger TargetType="Border" Binding="{Binding SelectedTabIndex}" Value="1">
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                        </DataTrigger>
                    </Border.Triggers>
                </Border>
            </Grid>

            <!-- Tab Content -->
            <Grid Grid.Row="1">
                <!-- Recipes Tab Content -->
                <recipeSummaryList:RecipeSummaryListControl
                    x:Name="RecipesListControl"
                    GetData="{Binding GetRecipesData, Source={Reference Root}}"
                    IsVisible="{Binding Source={x:Reference Root}, Path=BindingContext.SelectedTabIndex, Converter={StaticResource EqualToConverter}, ConverterParameter=0}" />

                <!-- Cookbook Tab Content -->
                <recipeSummaryList:RecipeSummaryListControl
                    x:Name="CookbookListControl"
                    GetData="{Binding GetCookbookData, Source={Reference Root}}"
                    IsVisible="{Binding Source={x:Reference Root}, Path=BindingContext.SelectedTabIndex, Converter={StaticResource EqualToConverter}, ConverterParameter=1}" />
            </Grid>
        </Grid>
        <adControls:MTAdView
            Grid.Row="2"
            HeightRequest="50"
            BackgroundColor="Transparent"
            AdsId="{x:Static constants:AdMobConstants.BannerAdUnitId}"
            AdSize="AnchoredAdaptive" />
    </Grid>
</views:BasePage>